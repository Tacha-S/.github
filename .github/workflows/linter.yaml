name: lint-test

on:
  workflow_call:

jobs:
  changed-file-filter:
    name: changed-file-filter
    runs-on: ubuntu-18.04
    outputs:
      cpp: ${{ steps.changes.outputs.cc }}
      python: ${{ steps.changes.outputs.python }}
      cmake: ${{ steps.changes.outputs.cmake }}
      yaml: ${{ steps.changes.outputs.yaml }}
      xml: ${{ steps.changes.outputs.xml }}
    steps:
      - name: changed-file-filter
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            cpp:
              - '**.h'
              - '**.hpp'
              - '**.hh'
              - '**.hxx'
              - '**.c'
              - '**.cpp'
              - '**.cc'
              - '**.cxx'
            python:
              - '**.py'
            cmake:
              - '**/CMakeLists.txt'
              - '**.cmake'
            yaml:
              - '**.yaml'
              - '**.yml'
            xml:
              - '**/launch/**.launch'
              - '**/launch/**.xml'
              - '**/package.xml'

  clang:
    name: runner / c++
    runs-on: ubuntu-18.04
    needs: changed-file-filter
    if: needs.changed-file-filter.outputs.cpp == 'true'
    steps:
      - name: Check out source repository
        uses: actions/checkout@v2
      - name: Download config
        run: wget https://raw.githubusercontent.com/Tacha-S/.github/main/.clang-format
      - uses: DoozyX/clang-format-lint-action@v0.12
        with:
          source: "."
          exclude: ""
          extensions: "h,cpp,hpp"
          clangFormatVersion: 8
          style: file
          inplace: true
      - name: suggester / clang-format
        uses: reviewdog/action-suggester@v1
        with:
          tool_name: clang-format
          filter_mode: file
          fail_on_error: true
  python-lint:
    name: runner / python
    runs-on: ubuntu-18.04
    needs: changed-file-filter
    if: needs.changed-file-filter.outputs.python == 'true'
    steps:
      - name: Check out source repository
        uses: actions/checkout@v2
      - name: Set up Python environment
        uses: actions/setup-python@v2
        with:
          python-version: "2.7"
      - name: autopep8 format
        uses: peter-evans/autopep8@v1
        with:
          args: --recursive --in-place --aggressive --aggressive --max-line-length 119 .
      - name: suggester / autopep8
        uses: reviewdog/action-suggester@v1
        with:
          tool_name: autopep8
          filter_mode: file
          fail_on_error: true
      - name: flake8 Lint
        if: always()
        uses: reviewdog/action-flake8@v3
        with:
          reporter: github-pr-review
          filter_mode: file
          fail_on_error: true
          flake8_args: --ignore=F401,W503 --max-line-length 119
  cmake:
    name: runner / cmake-format
    runs-on: ubuntu-18.04
    needs: changed-file-filter
    if: needs.changed-file-filter.outputs.cmake == 'true'
    steps:
      - name: Check out source repository
        uses: actions/checkout@v2
      - name: Download config
        run: wget https://raw.githubusercontent.com/Tacha-S/.github/main/.cmake-format
      - name: cmake-format
        uses: PuneetMatharu/cmake-format-lint-action@868082b20873d65687e64a4807ea342d1844c4c7
        with:
          args: -c .cmake-format -i
      # - name: cmake-format
      #   run: |
      #     pip3 install cmake-format
      #     files=`find . -name '*.cmake' -o -name 'CMakeLists.txt'`
      #     cmake-format -c .cmake-format -i ${files}
      - name: suggester / cmake-format
        uses: reviewdog/action-suggester@v1
        with:
          tool_name: cmake-format
          filter_mode: file
          fail_on_error: true
  yamllint:
    name: runner / yamllint
    runs-on: ubuntu-18.04
    needs: changed-file-filter
    if: needs.changed-file-filter.outputs.yaml == 'true'
    steps:
      - name: Check out source repository
        uses: actions/checkout@v2
      - name: Download config
        run: wget https://raw.githubusercontent.com/Tacha-S/.github/main/.yamllint
      - name: yamllint
        uses: reviewdog/action-yamllint@v1
        with:
          reporter: github-pr-review
          filter_mode: file
          fail_on_error: true
          yamllint_flags: -c .yamllint .
  xmllint:
    name: runner / xmllint
    runs-on: ubuntu-18.04
    needs: changed-file-filter
    if: needs.changed-file-filter.outputs.xml == 'true'
    steps:
      - name: Check out source repository
        uses: actions/checkout@v2
      - name: Setup reviewdog
        uses: reviewdog/action-setup@v1
      - name: xmllint format
        run: |
          sudo apt install libxml2-utils
          find . -type f -regextype posix-egrep -regex "(.*\/launch\/.*\.(launch|xml)|.*package.xml)$" -print0 |\
          xargs -0 -I {} -P8 bash -c "xmllint --format {} |\
          diff -B {} - |\
          patch {}"
      - name: suggester / xmllint
        uses: reviewdog/action-suggester@v1
        with:
          tool_name: xmllint
          filter_mode: file
          fail_on_error: true
      - name: xmllint roslaunch
        if: always()
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ github.token }}
        run: |
          wget https://gist.githubusercontent.com/nalt/dfa2abc9d2e3ae4feb82ca5608090387/raw/roslaunch.xsd
          files=`find . -type f -regextype posix-egrep -regex ".*\/launch\/.*\.(launch|xml)$"`
          xmllint --noout --schema roslaunch.xsd ${files} 2>&1 1>/dev/null |\
          reviewdog -name="xmllint" -reporter=github-pr-review -efm='%f:%l:%m' -filter-mode=file -fail-on-error
      - name: xmllint package.xml
        if: always()
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ github.token }}
        run: |
          wget http://download.ros.org/schema/package_format3.xsd
          files=`find . -type f -regextype posix-egrep -regex ".*package.xml"`
          xmllint --noout --schema package_format3.xsd ${files} 2>&1 1>/dev/null |\
          reviewdog -name="xmllint" -reporter=github-pr-review -efm='%f:%l:%m' -filter-mode=file -fail-on-error
